<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Risk Control Self-Assesment (RCSA) Versi Otomatis</title>
    <!-- Tailwind CSS for modern styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- SheetJS for Excel export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- EmailJS SDK -->
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
    <style>
        /* Import 'Inter' font from Google Fonts */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .sticky-header-container {
            position: relative;
            max-height: 500px; /* Increased height for better viewing */
            overflow: auto; /* Allows both vertical and horizontal scroll */
            border: 1px solid #e5e7eb;
            border-radius: 0.5rem;
            box-shadow: inset 0 2px 4px 0 rgba(0, 0, 0, 0.06);
            width: 100%;
        }
        /* PERBAIKAN FINAL: "Freeze Panes" untuk kedua baris header */
        .sticky-header-table thead th, .sticky-header-table thead td {
            position: sticky;
            background-color: #e9ecef; /* Warna sedikit diubah agar lebih jelas */
            z-index: 10;
        }
        .sticky-header-table thead tr:nth-child(1) th {
            top: 0;
            z-index: 11; 
        }
        .sticky-header-table thead tr:nth-child(2) td {
            top: 32px; /* Disesuaikan agar pas di bawah baris pertama */
        }
        .sticky-header-table { 
            border-collapse: collapse; 
            width: 100%;
            font-size: 0.75rem; /* Smaller font for more columns */
        }
        .sticky-header-table th, .sticky-header-table td { 
            padding: 6px 8px; 
            border: 1px solid #d1d5db; 
            text-align: left; 
        }
        .input-placeholder::placeholder { font-size: 0.875rem; color: #9ca3af; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen p-4 flex items-center justify-center">

<div class="w-full max-w-7xl bg-white p-8 rounded-2xl shadow-xl flex flex-col space-y-8">

    <!-- Header Section -->
    <header class="flex items-center space-x-4 mb-6 pb-4 border-b flex-col text-center">
        <div class="w-full h-auto rounded-2xl mb-4 relative overflow-hidden">
            <img id="headerImage" src="https://www.jmasyariah.com/wp-content/uploads/2025/07/1280-441px-100dpi.jpg.webp" alt="Header Image" class="w-full h-auto" onerror="this.onerror=null;this.src='https://placehold.co/800x200/cccccc/ffffff?text=Image+Not+Found';">
            <div class="absolute top-4 left-4 p-2 bg-white bg-opacity-80 rounded-lg">
            </div>
        </div>
        <div>
            <h1 class="text-3xl font-extrabold text-gray-800">Risk Control Self-Assesment (RCSA)</h1>
            <h2 class="text-xl font-bold text-gray-700">Versi Otomatis</h2>
            <p class="text-lg text-gray-600 font-normal">Untuk unit kerja di PT Asuransi Jiwa Syariah Jasa Mitra Abadi Tbk</p>
        </div>
        <marquee class="mt-4 text-blue-600 font-normal">
            Visi JMAS : Menjadi Asuransi Syariah Kebanggaan Masyarakat Indonesia. | Misi JMAS : Menyediakan Segala Kebutuhan Masyarakat Dalam Berasuransi, Memberi Kontribusi Bagi Industri Asuransi Syariah di Indonesia, dan Memberi Nilai Manfaat Yang Lebih Baik Bagi Seluruh Stakeholder.
        </marquee>
    </header>

    <!-- Main Form Section -->
    <div class="flex flex-col space-y-8">
        <div class="w-full flex flex-col space-y-6">
            <div class="space-y-2">
                <label for="titleInput" class="block text-sm font-medium text-gray-700">Gelar (Bapak/Ibu)</label>
                <select id="titleInput" class="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors text-sm">
                    <option value="" disabled selected>Pilih salah satu...</option>
                    <option value="Bapak">Bapak</option>
                    <option value="Ibu">Ibu</option>
                </select>
            </div>
            <div class="space-y-2">
                <label for="namaLengkap" class="block text-sm font-medium text-gray-700">Nama Lengkap (Risk Owner)</label>
                <input type="text" id="namaLengkap" placeholder="Contoh: Yanuar Wirandono" class="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors text-sm">
            </div>
            <!-- User Email Input -->
            <div class="space-y-2">
                <label for="userEmail" class="block text-sm font-medium text-gray-700">Alamat Email Anda (Wajib)</label>
                <input type="email" id="userEmail" placeholder="Hasil analisis akan dikirim ke email ini, contoh:yanuar.wirandono@jmasyariah.com" class="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors text-sm">
            </div>
            <div class="space-y-2">
                <label for="unitKerja" class="block text-sm font-medium text-gray-700">Unit Kerja (Berdasarkan SK No.017/SK-DIR/VII/2025)</label>
                <select id="unitKerja" class="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors text-sm">
                    <option value="" disabled selected>Pilih unit kerja...</option>
                    <option value="01-Bagian Corporate Secretary">01-Bagian Corporate Secretary</option>
                    <option value="02-Bagian Internal Audit">02-Bagian Internal Audit</option>
                    <option value="03-Bagian Manajemen Risiko, Compliance & Anti Fraud">03-Bagian Manajemen Risiko, Compliance & Anti Fraud</option>
                    <option value="04-Bagian APU-PPT">04-Bagian APU-PPT</option>
                    <option value="05-Bagian Human Resource & General Affairs">05-Bagian Human Resource & General Affairs</option>
                    <option value="06-Divisi Keuangan-Akuntansi">06-Divisi Keuangan-Akuntansi</option>
                    <option value="07-Divisi Keuangan-Treasury">07-Divisi Keuangan-Treasury</option>
                    <option value="08-Divisi Keuangan-Investasi">08-Divisi Keuangan-Investasi</option>
                    <option value="09-Divisi Keuangan-Inkaso">09-Divisi Keuangan-Inkaso</option>
                    <option value="10-Bagian Training & Development">10-Bagian Training & Development</option>
                    <option value="11-Bagian Marketing Support">11-Bagian Marketing Support</option>
                    <option value="12-Bagian Kapem. Banda Aceh">12-Bagian Kapem. Banda Aceh</option>
                    <option value="13-Divisi Pemasaran Group Insurance-Partnership Distribution">13-Divisi Pemasaran Group Insurance-Partnership Distribution</option>
                    <option value="14-Divisi Pemasaran Group Insurance-Group Employee Benefit">14-Divisi Pemasaran Group Insurance-Group Employee Benefit</option>
                    <option value="15-Divisi Pemasaran Retail-Area Sales Manager">15-Divisi Pemasaran Retail-Area Sales Manager</option>
                    <option value="16-Bagian Legal">16-Bagian Legal</option>
                    <option value="17-Divisi Informasi Teknologi-Software">17-Divisi Informasi Teknologi-Software</option>
                    <option value="18-Divisi Informasi Teknologi-Operasional">18-Divisi Informasi Teknologi-Operasional</option>
                    <option value="19-Divisi Teknik-Administrasi, Layanan, Kepesertaan, & Reasuransi">19-Divisi Teknik-Administrasi, Layanan, Kepesertaan, & Reasuransi</option>
                    <option value="20-Divisi Teknik-Seleksi & Pengendalian Risiko">20-Divisi Teknik-Seleksi & Pengendalian Risiko</option>
                    <option value="21-Divisi Teknik-Klaim">21-Divisi Teknik-Klaim</option>
                    <option value="22-Divisi Teknik-Penjaminan & Layanan ASKES">22-Divisi Teknik-Penjaminan & Layanan ASKES</option>
                    <option value="23-Divisi Aktuaria-Pricing & Product Development Asuransi Kesehatan">23-Divisi Aktuaria-Pricing & Product Development Asuransi Kesehatan</option>
                    <option value="24-Divisi Aktuaria-Pricing & Prodev. Non Asuransi Kesehatan">24-Divisi Aktuaria-Pricing & Prodev. Non Asuransi Kesehatan</option>
                    <option value="25-Divisi Aktuaria-Valuasi">25-Divisi Aktuaria-Valuasi</option>
                </select>
            </div>
            <div class="space-y-2">
                <label for="deskripsiProses" class="block text-sm font-medium text-gray-700">Deskripsi Proses Bisnis Unit Kerja</label>
                <textarea id="deskripsiProses" rows="6" placeholder="Jelaskan proses bisnis utama dari unit kerja, contoh: Divisi Teknik Bagian Adminitrasi Kepesertaan bertanggung jawab untuk verifikasi dokumen calon nasabah, input data ke sistem, penerbitan polis, dan pengelolaan dokumen kepesertaan. Proses ini melibatkan interaksi dengan agen dan Divisi Keuangan." class="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors text-sm"></textarea>
            </div>
            <div class="space-y-2">
                <label for="jumlahRisiko" class="block text-sm font-medium text-gray-700">Jumlah Risiko Utama</label>
                <input type="number" id="jumlahRisiko" value="5" min="1" max="20" class="w-20 p-3 text-center border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors text-sm">
            </div>
            <div class="space-y-2">
                <label for="uploadControl" class="block text-sm font-medium text-gray-700">Unggah Internal Control (Opsional)</label>
                <p class="text-sm text-gray-500">Unggah file (.pdf, .jpg, .png, dll) yang berisi SOP, peraturan, atau pedoman. (Maks. 5 file)</p>
                <input type="file" id="uploadControl" multiple accept=".pdf,image/*" class="w-full text-gray-700 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100 cursor-pointer transition-colors">
            </div>
            <button id="generateBtn" class="bg-blue-600 text-white font-bold py-3 px-6 rounded-lg shadow-md hover:bg-blue-700 transition-colors disabled:bg-blue-300 disabled:cursor-not-allowed">
                <i class="fas fa-magic mr-2"></i> Buat Analisis Risiko dan RCSA
            </button>
        </div>

        <!-- Output Display -->
        <div class="w-full mt-8 flex flex-col space-y-4">
            <h2 class="text-xl font-bold text-gray-800">Hasil Analisis Risiko dan RCSA</h2>
            <div id="output" class="bg-gray-50 p-6 rounded-md border border-gray-300 shadow-inner text-sm text-gray-700">
                <p class="text-center text-gray-500">Hasil akan muncul di sini.</p>
            </div>
            <div class="flex justify-end mt-4">
                <button id="exportExcelBtn" class="bg-green-600 text-white font-bold py-2 px-4 rounded-lg shadow-md hover:bg-green-700 transition-colors disabled:bg-green-300 disabled:cursor-not-allowed hidden">
                    <i class="fas fa-file-excel mr-2"></i> Export ke Microsoft Excel
                </button>
            </div>
            <div id="loading" class="text-center text-blue-600 hidden">
                <p><i class="fas fa-spinner fa-spin mr-2"></i> Sedang membuat daftar risiko, mohon tunggu...</p>
            </div>
            <div id="error" class="text-center text-red-500 hidden">
                <p><i class="fas fa-exclamation-triangle mr-2"></i> Terjadi kesalahan. Pastikan semua kolom wajib terisi.</p>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="text-center mt-6 text-sm text-gray-500 pt-4 border-t">
        <p>Created by: yanuar.wirandono@jmasyariah – Manajemen Risiko, Kepatuhan & Anti-Fraud</p>
        <p>© 2025 PT Asuransi Jiwa Syariah Jasa Mitra Abadi Tbk</p>
    </footer>

</div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        // Initialize EmailJS with your Public Key
        // emailjs.init({ publicKey: "YOUR_PUBLIC_KEY" });

        const generateBtn = document.getElementById('generateBtn');
        const exportExcelBtn = document.getElementById('exportExcelBtn');
        const titleInput = document.getElementById('titleInput');
        const namaLengkapInput = document.getElementById('namaLengkap');
        const userEmailInput = document.getElementById('userEmail');
        const unitKerjaInput = document.getElementById('unitKerja');
        const deskripsiProsesInput = document.getElementById('deskripsiProses');
        const jumlahRisikoInput = document.getElementById('jumlahRisiko');
        const uploadControlInput = document.getElementById('uploadControl');
        const outputDiv = document.getElementById('output');
        const loadingDiv = document.getElementById('loading');
        const errorDiv = document.getElementById('error');

        // =================================================================
        // PUSAT KONFIGURASI GAYA KOLOM (LEBIH RAPI & MUDAH DIEDIT)
        // =================================================================
        const columnStylingConfig = {
            default: { textAlign: 'left', whiteSpace: 'normal' },
            headerDefault: { textAlign: 'center' },
            overrides: {
                0:  { textAlign: 'center' },
                1:  { minWidth: '25ch' }, // UNIT KERJA (RISK OWNER)
                2:  { minWidth: '25ch' }, // NAMA RISK OWNER
                3:  { minWidth: '35ch' }, // SASARAN
                4:  { minWidth: '35ch' }, // KEGIATAN
                5:  { minWidth: '40ch' }, // PERISTIWA RISIKO
                6:  { textAlign: 'center' }, // SUMBER RISIKO 
                7:  { minWidth: '20ch', textAlign: 'center' }, // KATEGORI RISIKO
                8:  { minWidth: '45ch' }, // PENYEBAB RISIKO
                9:  { minWidth: '13ch', textAlign: 'center' }, // KATEGORI PENYEBAB RISIKO
                10: { minWidth: '40ch' }, // DAMPAK RISIKO
                11: { minWidth: '13ch', textAlign: 'right' }, // ESTIMASI BIAYA KERUGIAN (Rp)
                12: { textAlign: 'center' }, // ASESMEN INHEREN (KEMUNGKINAN)
                13: { textAlign: 'center' }, // ASESMEN INHEREN (DAMPAK)
                14: { textAlign: 'center' }, // SKOR INHEREN
                15: { textAlign: 'center' }, // PERINGKAT INHEREN
                16: { minWidth: '13ch', textAlign: 'right' }, // TGL. ASESMEN INHEREN
                17: { minWidth: '40ch' }, // EXISTING CONTROL
                18: { textAlign: 'center' }, // EVALUASI EXISTING CONTROL
                19: { textAlign: 'center' }, // PERLAKUAN RISIKO
                20: { minWidth: '40ch' }, // RENCANA MITIGASI
                21: { textAlign: 'right' }, // TARGET PELAKSANAAN MITIGASI
                22: { textAlign: 'right' }, // ESTIMASI BIAYA MITIGASI (Rp)
                23: { textAlign: 'center' }, // ASESMEN RESIDUAL (KEMUNGKINAN)
                24: { textAlign: 'center' }, // ASESMEN RESIDUAL (DAMPAK)
                25: { minWidth: '10ch', textAlign: 'center' }, // SKOR RESIDUAL
                26: { textAlign: 'center' }, // PERINGKAT RESIDUAL
                27: { textAlign: 'right' } // TGL. ASESMEN RESIDUAL
            }
        };

        function getHeaderStyles(index) {
            // Gabungkan gaya dari konfigurasi
            const styles = { ...columnStylingConfig.headerDefault, ...columnStylingConfig.overrides[index] };
            
            // PERUBAHAN: Secara eksplisit mengatur dan memastikan perataan teks adalah 'center'
            // untuk semua sel di baris header dan baris nomor.
            styles.textAlign = 'center'; 
            
            if ([1, 2, 25].includes(index)) {
                styles.whiteSpace = 'normal';
            }
            return Object.entries(styles).map(([key, value]) => `${key.replace(/([A-Z])/g, '-$1').toLowerCase()}:${value}`).join(';');
        }
        // =================================================================
        // AKHIR DARI PUSAT KONFIGURASI
        // =================================================================

        jumlahRisikoInput.addEventListener('change', () => {
            if (jumlahRisikoInput.value < 1) jumlahRisikoInput.value = 1;
            if (jumlahRisikoInput.value > 20) jumlahRisikoInput.value = 20;
        });

        exportExcelBtn.addEventListener('click', () => {
            const table = outputDiv.querySelector('table');
            if (table) {
                const ws = XLSX.utils.table_to_sheet(table);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "RCSA");
                XLSX.writeFile(wb, "RCSA_JMAS.xlsx");
            } else {
                showStatusMessage('Tidak ada tabel RCSA untuk diexport.', 'warning');
            }
        });

        function showStatusMessage(message, type) {
            let statusDiv = document.getElementById('status-message');
            if (!statusDiv) {
                statusDiv = document.createElement('div');
                statusDiv.id = 'status-message';
                document.body.appendChild(statusDiv);
            }
            statusDiv.textContent = message;
            statusDiv.className = `fixed bottom-4 left-1/2 -translate-x-1/2 px-4 py-2 rounded-lg shadow-lg text-white font-semibold z-50 transition-transform duration-300 transform scale-100 ${type === 'error' ? 'bg-red-500' : 'bg-blue-500'}`;
            setTimeout(() => {
                statusDiv.className = statusDiv.className.replace('scale-100', 'scale-0');
            }, 3000);
        }
        
        function getUserLocation() {
            return new Promise((resolve) => {
                if (!navigator.geolocation) {
                    resolve("Geolocation tidak didukung oleh browser ini.");
                    return;
                }
                navigator.geolocation.getCurrentPosition(
                    async (position) => {
                        try {
                            const lat = position.coords.latitude;
                            const lon = position.coords.longitude;
                            const response = await fetch(`https://api.bigdatacloud.net/data/reverse-geocode-client?latitude=${lat}&longitude=${lon}&localityLanguage=id`);
                            const data = await response.json();
                            const locationString = `${data.locality}, ${data.city}, ${data.principalSubdivision}, ${data.countryName}`;
                            resolve(locationString);
                        } catch (error) {
                            resolve("Gagal mendapatkan nama lokasi.");
                        }
                    },
                    () => {
                        resolve("Pengguna tidak mengizinkan akses lokasi.");
                    }
                );
            });
        }

        // Function to send email log to ADMIN
        async function sendAdminLog(timestamp, location) {
            const templateParams = {
                user_email: userEmailInput.value.trim(),
                form_data: `
                    Tanggal & Jam: ${timestamp}
                    Perkiraan Lokasi: ${location}
                    ---------------------------------
                    Gelar: ${titleInput.value.trim()}
                    Nama Lengkap: ${namaLengkapInput.value.trim()}
                    Unit Kerja: ${unitKerjaInput.value.trim()}
                    Deskripsi Proses: ${deskripsiProsesInput.value.trim()}
                    Jumlah Risiko: ${jumlahRisikoInput.value}
                `,
                hasil_html: outputDiv.innerHTML
            };

            try {
                // await emailjs.send('YOUR_SERVICE_ID', 'YOUR_ADMIN_TEMPLATE_ID', templateParams);
                console.log('Email log admin berhasil dikirim (simulasi).');
            } catch (error) {
                console.error('Gagal mengirim email log admin:', error);
            }
        }

        // Function to send results to USER
        async function sendResultsToUser(timestamp, location) {
             const templateParams = {
                to_email: userEmailInput.value.trim(),
                form_data: `
                    Tanggal & Jam: ${timestamp}
                    Perkiraan Lokasi: ${location}
                    ---------------------------------
                    Gelar: ${titleInput.value.trim()}
                    Nama Lengkap: ${namaLengkapInput.value.trim()}
                    Unit Kerja: ${unitKerjaInput.value.trim()}
                    Deskripsi Proses: ${deskripsiProsesInput.value.trim()}
                    Jumlah Risiko: ${jumlahRisikoInput.value}
                `,
                hasil_html: outputDiv.innerHTML
            };

            try {
                // await emailjs.send('YOUR_SERVICE_ID', 'YOUR_USER_TEMPLATE_ID', templateParams);
                console.log('Email hasil berhasil dikirim ke pengguna (simulasi).');
                showStatusMessage('Hasil analisis berhasil dikirim ke email Anda.', 'success');
            } catch (error) {
                console.error('Gagal mengirim email ke pengguna:', error);
                showStatusMessage('Gagal mengirim hasil ke email Anda.', 'error');
            }
        }

        // Helper function for risk scoring and coloring
        function getRiskStyling(score) {
            const numericScore = parseInt(score, 10);
            if (isNaN(numericScore)) return { color: '#FFFFFF', rank: 'N/A' };

            if (numericScore >= 17) return { color: '#FF0000', rank: 'SANGAT TINGGI' };
            if (numericScore >= 13) return { color: '#FFA500', rank: 'SEDANG TINGGI' };
            if (numericScore >= 9) return { color: '#FFFF00', rank: 'SEDANG' };
            if (numericScore >= 5) return { color: '#A9FA26', rank: 'SEDANG RENDAH' };
            if (numericScore >= 1) return { color: '#00B050', rank: 'RENDAH' };
            return { color: '#FFFFFF', rank: 'N/A' };
        }

        generateBtn.addEventListener('click', async () => {
            const title = titleInput.value.trim();
            const namaLengkap = namaLengkapInput.value.trim();
            const userEmail = userEmailInput.value.trim();
            const unitKerjaRaw = unitKerjaInput.value.trim();
            const deskripsiProses = deskripsiProsesInput.value.trim();
            const jumlahRisiko = jumlahRisikoInput.value;

            if (!title || !namaLengkap || !userEmail || !unitKerjaRaw || !deskripsiProses) {
                errorDiv.textContent = 'Pastikan semua kolom wajib (Gelar, Nama, Email, Unit Kerja, Deskripsi) sudah terisi.';
                errorDiv.classList.remove('hidden');
                return;
            }
            errorDiv.classList.add('hidden');

            loadingDiv.classList.remove('hidden');
            generateBtn.disabled = true;
            exportExcelBtn.classList.add('hidden');
            outputDiv.innerHTML = `<p class="text-center text-gray-500">Hasil akan muncul di sini.</p>`;

            const timestamp = new Date().toLocaleString('id-ID', { timeZone: 'Asia/Jakarta' });
            const location = await getUserLocation();
            const unitKerja = unitKerjaRaw.substring(3);

            try {
                
                const today = new Date().toLocaleDateString('id-ID', { day: '2-digit', month: '2-digit', year: 'numeric' });
                
                let prompt = `Berdasarkan deskripsi proses bisnis "${deskripsiProses}" pada unit kerja "${unitKerja}", yang diisi oleh ${title} ${namaLengkap}, tolong buatkan analisis RCSA yang detail.

Pertama, buatlah analisis risiko dalam dua paragraf terpisah. Mulai langsung dengan paragraf pertama tanpa kalimat pembuka apa pun:
- Paragraf 1: Analisis proses bisnis tersebut dari sudut pandang kerangka kerja ISO 31000:2018 dan COSO-ERM.
- Paragraf 2: Analisis proses bisnis yang sama dari sudut pandang peraturan dan perundang-undangan tentang asuransi yang berlaku di Indonesia berdasarkan prinsip syariah.

Kedua, setelah analisis naratif selesai, Identifikasi ${jumlahRisiko} Risiko Utama dalam tabel RCSA dan susun dalam format tabel Markdown dengan 28 kolom sesuai ketentuan berikut. Isi setiap kolom dengan serealistis mungkin:

| RISK ID | UNIT KERJA (RISK OWNER) | NAMA RISK OWNER | SASARAN | KEGIATAN | PERISTIWA RISIKO | SUMBER RISIKO | KATEGORI RISIKO | PENYEBAB RISIKO | KATEGORI PENYEBAB RISIKO | DAMPAK RISIKO | ESTIMASI BIAYA KERUGIAN (Rp) | ASESMEN INHEREN (KEMUNGKINAN) | ASESMEN INHEREN (DAMPAK) | SKOR INHEREN | PERINGKAT INHEREN | TGL. ASESMEN INHEREN | EXISTING CONTROL | EVALUASI EXISTING CONTROL | PERLAKUAN RISIKO | RENCANA MITIGASI | TARGET PELAKSANAAN MITIGASI | ESTIMASI BIAYA MITIGASI (Rp) | ASESMEN RESIDUAL (KEMUNGKINAN) | ASESMEN RESIDUAL (DAMPAK) | SKOR RESIDUAL | PERINGKAT RESIDUAL | TGL. ASESMEN RESIDUAL |
|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|

**Panduan Pengisian Kolom:**
- **RISK ID**: Buat kode unik, contoh: RO-001.
- **UNIT KERJA & NAMA RISK OWNER**: Isi dengan "${unitKerja}" dan "${namaLengkap}".
- **SASARAN & KEGIATAN**: Jabarkan dari deskripsi proses bisnis.
- **SUMBER RISIKO**: Pilih salah satu: Internal, Eksternal, Internal & Eksternal.
- **KATEGORI RISIKO**: Pilih salah satu: Risiko Asuransi, Risiko Hukum, Risiko Kepatuhan, Risiko Kredit, Risiko Likuiditas, Risiko Operasional, Risiko Pasar, Risiko Reputasi, Risiko Strategis.
- **KATEGORI PENYEBAB RISIKO**: Pilih salah satu: SDM, Sistem/IT, Prosedur, Eksternal.
- **ESTIMASI BIAYA**: Berikan angka perkiraan dalam Rupiah (contoh: 50.000.000).
- **ASESMEN KEMUNGKINAN & DAMPAK**: Gunakan skala angka 1 sampai 5.
- **SKOR & PERINGKAT**: Hitung (Kemungkinan x Dampak) dan tentukan peringkatnya (RENDAH, SEDANG RENDAH, SEDANG, SEDANG TINGGI, SANGAT TINGGI). **Hanya tuliskan angka skor di kolom SKOR dan teks peringkat di kolom PERINGKAT.**
- **TGL. ASESMEN**: Gunakan tanggal hari ini (${today}).
- **EVALUASI EXISTING CONTROL**: Pilih salah satu: Efektif, Kurang efektif, Tidak efektif.
- **PERLAKUAN RISIKO**: Pilih salah satu: Accept (Diterima), Share (Dibagi), Transfer (Dialihkan), Reduce (Dikurangi), Avoid (Dihindari).
- **TARGET PELAKSANAAN MITIGASI**: Berikan tanggal di masa depan (DD/MM/YYYY).
`;
                
                const apiKey = "AIzaSyDvMr8A7QPGGTYPuYpLDkJf0IUkRkJlFho";

const apiUrl =
`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${apiKey}`;
                
                let response;
                let retries = 0;
                const maxRetries = 5;
                while (retries < maxRetries) {
                    try {
                        response = await fetch(apiUrl, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ contents: [{ role: "user", parts: [{ text: prompt }] }] })
                        });
                        if (response.status === 429) {
                            const delay = Math.pow(2, retries++) * 1000;
                            await new Promise(res => setTimeout(res, delay));
                            continue;
                        }
                        break;
                    } catch (error) {
                        if (retries < maxRetries - 1) {
                            const delay = Math.pow(2, retries++) * 1000;
                            await new Promise(res => setTimeout(res, delay));
                        } else { throw error; }
                    }
                }

                if (!response || !response.ok) {
                    const errorBody = await response.text();
                    throw new Error(`API call failed with status: ${response.status}. Response: ${errorBody}`);
                }
                
                const result = await response.json();
                
                if (result.candidates && result.candidates[0]?.content?.parts?.[0]) {
                    const text = result.candidates[0].content.parts[0].text;
                    
                    const lines = text.split('\n');
                    let tableStartIndex = lines.findIndex(line => line.trim().startsWith('| RISK ID |'));
                    
                    let analysisLines = [];
                    let tableLines = [];

                    if (tableStartIndex !== -1) {
                        analysisLines = lines.slice(0, tableStartIndex);
                        tableLines = lines.slice(tableStartIndex);
                    } else {
                        analysisLines = lines;
                    }

                    let introHtml = `<p class="italic">Assalamu'alaikum Warahmatullahi Wabarakatuh</p><p class="mt-2">Salam hangat! <strong>${title} ${namaLengkap}</strong> semoga Anda selalu dalam kondisi sehat walafiat.</p><p class="mt-4 text-justify">Saya Yanuar Wirandono, CRMP dari Bagian Manajemen Risiko, Kepatuhan dan Anti-Fraud JMAS akan membantu Anda dalam menyusun RCSA untuk proses bisnis <strong>${deskripsiProses}</strong> pada unit kerja <strong>${unitKerja}</strong> di PT Asuransi Jiwa Syariah Jasa Mitra Abadi Tbk sesuai framework ISO 31000:2018, COSO-ERM, POJK No.44 Tahun 2020 serta Peraturan dan Perundang-undangan tentang Perasuransian yang berlaku di Indonesia berdasarkan prinsip syariah.</p>`;
                    
                    const formattedAnalysisHtml = analysisLines.filter(p => p.trim() !== '' && !p.trim().startsWith('- ')).map(p => `<p class="text-justify">${p.trim().replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')}</p>`).join('');
                    let mainContent = `<div class="w-full bg-gray-50 p-6 rounded-md border border-gray-300 shadow-inner flex flex-col space-y-4"><p class="font-bold">Hasil Analisis</p>${formattedAnalysisHtml}</div>`;

                    let tableSection = '';
                    if (tableLines.length > 2) { 
                        const headers = tableLines[0].split('|').map(h => h.trim()).filter(Boolean);
                        
                        // =================================================================
                        // PERUBAHAN: Menerapkan pemformatan kolom
                        // =================================================================
                        
                        const getColumnStyles = (index) => {
                            let styles = '';
                            const centerAlign = [0, 6, 7, 9, 12, 13, 14, 15, 18, 19, 23, 24, 25, 26];
                            const rightAlign = [11, 16, 21, 22, 27];
                            if (centerAlign.includes(index)) styles += 'text-align: center; ';
                            else if (rightAlign.includes(index)) styles += 'text-align: right; ';
                            else styles += 'text-align: left; ';

                            const wider40 = [5, 10, 20];
                            const wrapFitHeader = [11, 16, 19, 22, 25];
                            
                            if (wider40.includes(index)) styles += 'min-width: 40ch; ';
                            
                            if (wrapFitHeader.includes(index)) {
                                styles += 'white-space: normal; min-width: 15ch; ';
                            } else {
                                styles += 'white-space: normal;';
                            }
                            return styles;
                        };

                        const getHeaderStyles = (index) => {
                            let styles = 'text-align: center; ';
                            const wider40 = [5, 10, 20];
                            const wrapFitHeader = [11, 16, 19, 22, 25];
                            const twoLineHeaders = [1, 2, 25]; // Kolom 2, 3, 26

                            if (twoLineHeaders.includes(index)) {
                                styles += 'white-space: normal; ';
                            } else {
                                if (wider40.includes(index)) styles += 'min-width: 40ch; ';
                                if (wrapFitHeader.includes(index)) styles += 'min-width: 15ch; ';
                            }
                            return styles;
                        };

                        const headerHtml = headers.map((header, i) => {
                            let headerText = header;
                            // Mengganti teks header spesifik menjadi format 2 baris
                            if (i === 1) { // Kolom 2
                                headerText = 'UNIT KERJA <br>(RISK OWNER)';
                            } else if (i === 2) { // Kolom 3
                                headerText = 'NAMA <br>RISK OWNER';
                            } else if (i === 25) { // Kolom 26
                                headerText = 'SKOR <br>RESIDUAL';
                            }
                            return `<th style="${getHeaderStyles(i)}">${headerText}</th>`;
                        }).join('');

                        const numberRowHtml = headers.map((_, i) => `<td class="font-bold" style="${getHeaderStyles(i)}">${i + 1}</td>`).join('');

                        const htmlTableBody = tableLines.slice(2).map(line => {
                            if (!line.trim().startsWith('|')) return '';
                            const cells = line.split('|').map(cell => cell.trim()).slice(1, -1);
                            if (cells.length !== headers.length) return '';
                            
                            let inherenScore = parseInt(cells[14], 10);
                            let residualScore = parseInt(cells[25], 10);

                            const rowHtml = cells.map((cell, i) => {
                                const header = headers[i];
                                let cellStyle = getColumnStyles(i);
                                let cellContent = cell.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');

                                if (header === 'SKOR INHEREN' || header === 'PERINGKAT INHEREN') {
                                    const styling = getRiskStyling(inherenScore);
                                    cellStyle += `background-color: ${styling.color};`;
                                    if (header === 'PERINGKAT INHEREN') cellContent = styling.rank;
                                } else if (header === 'SKOR RESIDUAL' || header === 'PERINGKAT RESIDUAL') {
                                    const styling = getRiskStyling(residualScore);
                                    cellStyle += `background-color: ${styling.color};`;
                                    if (header === 'PERINGKAT RESIDUAL') cellContent = styling.rank;
                                }
                                
                                return `<td style="${cellStyle}">${cellContent}</td>`;
                            }).join('');
                            return `<tr>${rowHtml}</tr>`;
                        }).join('');

                        tableSection = `<div class="w-full bg-gray-50 p-6 rounded-md border border-gray-300 shadow-inner flex flex-col space-y-4 mt-8"><div class="mt-4 mb-4"><p class="font-bold">RCSA - ${deskripsiProses}</p><p class="font-bold">Unit Kerja: ${unitKerja}</p><p class="font-bold">PT Asuransi Jiwa Syariah Jasa Mitra Abadi Tbk.</p></div><div class="sticky-header-container"><table id="rcsaTable" class="sticky-header-table"><thead><tr>${headerHtml}</tr><tr>${numberRowHtml}</tr></thead><tbody>${htmlTableBody}</tbody></table></div></div>`;
                    }
                    
                    let conclusionHtml = `<div class="mt-4 text-sm text-gray-600 border-t pt-4"><p class="text-justify"><strong>Keterangan:</strong></p><p class="text-justify">Risk Owner harap melakukan penyesuaian terhadap RCSA ini dengan kondisi faktual dan ketersediaan sumberdaya yang ada di unit kerja, serta mendiskusikan dengan tim dan pimpinan unit kerja (Key Risk Owner) sebelum **menyalin** RCSA ini pada Sistem Informasi Manajemen Risiko Korporasi (SIMRK) JMAS.</p><p class="mt-2 italic">Wassalamu'alaikum Warahmatullahi Wabarakatuh</p></div>`;
                    
                    outputDiv.innerHTML = introHtml + mainContent + tableSection + conclusionHtml;
                    outputDiv.classList.remove('text-center');
                    exportExcelBtn.classList.remove('hidden');

                    // Send both emails
                    await sendAdminLog(timestamp, location);
                    await sendResultsToUser(timestamp, location);

                } else {
                    throw new Error('Gagal mendapatkan respons dari AI. Silakan coba lagi.');
                }
            } catch (err) {
                console.error(err);
                errorDiv.textContent = `Terjadi kesalahan: ${err.message}`;
                errorDiv.classList.remove('hidden');
            } finally {
                loadingDiv.classList.add('hidden');
                generateBtn.disabled = false;
            }
        });
    })
</script>

</body>
</html>

